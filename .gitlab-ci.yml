stages:
  - build
  - deploy

.libjpeg:
  before_script:
    - curl http://www.ijg.org/files/jpegsrc.v9d.tar.gz > jpegsrc.tar.gz
    - tar xvf jpegsrc.tar.gz
    - cd jpeg-9d
    - ./configure --enable-static --with-pic
    - make install
    - cd ..

.wheel:
  image: quay.io/pypa/manylinux2014_x86_64
  extends: .libjpeg
  stage: build
  variables: 
    PYBIN: /opt/python/$PYVER/bin
  script:
    - yum install util-linux
    - ${PYBIN}/pip install -r dev-requirements.txt
    - ${PYBIN}/pip wheel . --no-deps -w dist/
    - rename linux manylinux2014 dist/*
  artifacts:
    paths:
      - dist/*
  when: manual
  
wheel-36:
  extends: .wheel
  variables: 
    PYVER: cp36-cp36m
    
wheel-37:
  extends: .wheel
  variables: 
    PYVER: cp37-cp37m

wheel-38:
  extends: .wheel
  variables: 
    PYVER: cp38-cp38

pypi:
  stage: deploy
  image: python
  script:
    - pip install -r dev-requirements.txt
    - twine -u __token__ -p ${pypi_push_key} upload dist/*
  when: on_success

pages:
  extends: .libjpeg
  stage: deploy
  image: python
  script:
    - python setup.py install
    - cd doc
    - pip install requirements.txt
    - make html
    - mv build ../public
  artifacts:
    paths:
      - public
  when: on_success